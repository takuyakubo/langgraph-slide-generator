# システムアーキテクチャ

## 概要

LangGraph Slide Generatorは、複数の処理ステージで構成されるパイプラインを中心に構築されています。このシステムはLangGraphを活用して複雑なワークフローを調整し、各処理ステージ間の状態遷移を管理します。

## 高レベルアーキテクチャ

システムは以下の主要コンポーネントで構成されています：

```
+----------------+     +------------------+     +------------------+     +------------------+
|                |     |                  |     |                  |     |                  |
|   画像入力     +---->+   画像解析       +---->+   コンテンツ解析  +---->+   HTML生成      |
|                |     |                  |     |                  |     |                  |
+----------------+     +------------------+     +------------------+     +------------------+
```

## コンポーネント構成

### 1. 画像処理モジュール

- **画像前処理**: 画像の強調、正規化、解析のための準備を行います
- **OCRエンジン**: 日本語文字のサポートを含む画像からテキストを抽出します
- **レイアウト解析**: 見出し、段落、リストなどの構造要素を識別します
- **数式検出**: 数式を識別して抽出します

### 2. LangGraphワークフローマネージャ

- **状態管理**: パイプライン全体を通じて処理状態を維持・更新します
- **プロセス調整**: 処理ステップの実行を調整します
- **エラー処理**: 処理中のエラーと例外を管理します
- **イベント追跡**: モニタリングとデバッグのためのイベントと状態遷移を記録します

### 3. LLM解析モジュール

- **コンテンツ理解**: 抽出されたコンテンツの意味と構造を理解するためにLLMを使用します
- **階層検出**: コンテンツ要素間の階層関係を識別します
- **主要概念抽出**: 主要な概念と専門用語を識別します
- **意味的注釈**: コンテンツにセマンティックメタデータを追加します

### 4. HTML生成器

- **テンプレートエンジン**: 一貫したHTML構造を生成するためのテンプレートを使用します
- **スタイルマネージャ**: コンテンツ分析に基づいて適切なCSSスタイルを適用します
- **数式レンダラー**: 数式をMathJax互換形式に変換します
- **スライド分割**: コンテンツ構造に基づいて適切なスライド境界を決定します

### 5. APIサービス

- **リクエストハンドラ**: 受信したAPIリクエストを処理します
- **認証**: ユーザーのアクセス資格情報を検証します
- **ジョブスケジューラ**: 処理ジョブとリソースを管理します
- **レスポンスフォーマッタ**: 処理結果をフォーマットして返します

## データフロー

1. **入力ステージ**:
   - ユーザーがAPI経由で画像を送信
   - 画像が検証され、処理のために保存
   - 処理ジョブが作成され、スケジュールされる

2. **画像解析ステージ**:
   - 最適なOCRパフォーマンスのために画像が前処理される
   - 日本語コンテンツに最適化されたOCRを使用してテキストが抽出される
   - レイアウトと構造要素が識別される
   - 数式が検出され抽出される

3. **コンテンツ解析ステージ**:
   - LLMが抽出されたテキストを分析してコンテンツ構造を理解する
   - コンテンツ要素間の階層関係が識別される
   - 主要な概念と専門用語が抽出される
   - HTML生成のためにコンテンツが意味的に注釈付けされる

4. **HTML生成ステージ**:
   - コンテンツ構造がHTML要素にマッピングされる
   - コンテンツ構造に基づいてスライド境界が決定される
   - 適切なCSSスタイルが適用される
   - MathJaxを使用して数式がレンダリングされる
   - 複数スライドのプレゼンテーション用にナビゲーション要素が追加される

5. **出力ステージ**:
   - 生成されたHTMLスライドが検証される
   - 処理結果が保存される
   - ユーザーに完了が通知される
   - 結果が取得可能になる

## 主要設計判断

### ワークフロー調整にLangGraphを選択した理由

LangGraphを主要なワークフロー調整ツールとして選択した理由：

- 複雑な処理パイプラインを定義・管理するための柔軟なフレームワークを提供
- コンテンツ理解と生成のためにLLMとのスムーズな統合が可能
- 非同期処理と状態管理をサポート
- ワークフロー実行のモニタリングとデバッグのためのツールを提供

### モジュラーアーキテクチャ

システムはモジュラーアーキテクチャを採用：

- コンポーネントの独立した開発とテストを可能に
- 個々のモジュールの容易な交換や更新を可能に
- 複数チームによる並行開発をサポート
- 他のアプリケーションでのコンポーネントの再利用を促進

### 関心の分離

アーキテクチャは画像処理、コンテンツ解析、HTML生成を分離：

- 各タスクに特化したツールと技術を活用
- 各処理ステージの独立した最適化を可能に
- 適切な場所での並列処理を可能に
- メンテナンスとトラブルシューティングを簡素化

## データモデル

システムは以下の主要なデータモデルに基づいています：

### 処理状態

```
ProcessingState
  - job_id: str
  - status: ProcessingStatus (PENDING/PROCESSING/COMPLETED/FAILED)
  - images: List[bytes]
  - image_metadata: List[ImageMetadata]
  - extracted_text: List[ExtractedText]
  - content_structure: List[ContentStructure]
  - slide_definitions: List[SlideDefinition]
  - html_output: Optional[str]
  - errors: List[str]
  - progress: int
```

### 抽出テキスト

```
ExtractedText
  - text_boxes: List[TextBox]
  - math_expressions: List[MathExpression]
  - raw_text: str
  - language: str
  - confidence: float
```

### コンテンツ構造

```
ContentStructure
  - title: Optional[str]
  - subtitle: Optional[str]
  - sections: List[ContentSection]
```

### スライド定義

```
SlideDefinition
  - title: Optional[str]
  - subtitle: Optional[str]
  - type: str (cover/toc/content/divider)
  - elements: List[SlideElement]
  - style: Dict[str, str]
```

## テクノロジースタック

### バックエンド

- **Python**: メイン実装言語
- **FastAPI**: REST API実装
- **LangGraph**: ワークフロー管理
- **LangChain**: LLM統合
- **Redis**: ジョブキューと一時データストレージ
- **PostgreSQL**: 永続データストレージ

### 画像処理

- **OpenCV**: 画像前処理と解析
- **Tesseract OCR**: テキスト抽出（日本語サポート）
- **EasyOCR**: 日本語テキスト認識の代替オプション
- **Mathpix**: または同様のサービスによる数式抽出

### フロントエンド（Webインターフェース実装時）

- **React**: ユーザーインターフェースフレームワーク
- **TailwindCSS**: スタイリング
- **MathJax**: 数式レンダリング

### デプロイメント

- **Docker**: コンテナ化
- **Kubernetes**: オーケストレーション（大規模デプロイメント用）
- **AWS/GCP/Azure**: クラウドホスティング

## スケーラビリティと性能

### 水平スケーリング

- ステートレスAPIレイヤー
- 処理ワーカープールのスケーリング
- ジョブキューを通じた負荷分散

### 性能最適化

- 画像前処理のチューニング
- OCR精度と速度のバランス
- LLM推論の最適化
- キャッシュ戦略

### リソース使用量

- 画像サイズと複雑さに基づく動的リソース割り当て
- 同時実行制限によるリソース過負荷の防止
- バッチ処理による効率化

## セキュリティ考慮事項

- JWT/APIキーベースの認証
- TLS/SSLによる暗号化
- 安全なファイル処理
- 入力検証とサニタイズ
- アクセス制御と認可
- 機密データ保護

## 将来の拡張性

アーキテクチャは将来の拡張を念頭に設計されています：

1. **追加言語サポート**: 他の言語への対応拡大
2. **高度な画像解析**: チャートやグラフの検出と解析
3. **インタラクティブ要素**: インタラクティブなHTML要素の生成
4. **AIドリブンのカスタマイズ**: ユーザー好みに基づくテンプレート自動選択
5. **マルチメディア統合**: 音声や動画コンテンツの処理とスライドへの統合
