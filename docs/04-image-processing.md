# 画像処理

## 概要

画像処理コンポーネントは、入力画像の処理、テキストコンテンツの抽出、後続の処理段階で使用される構造要素の識別を担当します。このドキュメントでは、特に日本語テキストと技術的内容を含む教科書ページ画像を効果的に解析するための戦略、技術、考慮事項について詳しく説明します。

## ワークフロー

1. **画像前処理**
   - 画像の強調と正規化
   - 必要に応じた遠近補正
   - ノイズ削減と品質向上
   - コンテンツ領域への画像セグメンテーション

2. **テキスト抽出**
   - 日本語テキストのOCR処理
   - 日本語と英語が混在するテキストの処理
   - 数式表現と方程式の抽出
   - 抽出されたテキストの信頼度スコアリング

3. **構造識別**
   - 見出し、小見出し、セクションタイトルの検出
   - 段落、リスト、箇条書きの識別
   - 注釈、メモ、ハイライトされたテキストの認識
   - 表と表形式データの識別

4. **レイアウト分析**
   - 読み取り順序の決定
   - 段組の検出と処理
   - 複数段組レイアウトの処理
   - コンテンツフローと論理的グループ化の識別

## 日本語テキスト処理

### OCR考慮事項

- 日本語テキスト用に訓練された特殊なOCRモデルの使用
- 縦書きと横書きのテキスト方向のサポート
- ふりがな（読み方補助）や特殊文字の処理
- 日本語の句読点と書式規則の認識

### 文字セット処理

- 日本語文字の全範囲（ひらがな、カタカナ、漢字）のサポート
- 日本語の句読点と記号の適切な処理
- 半角文字と全角文字のサポート
- 日本語とラテン文字が混在するテキストの処理

## 数式表現の処理

### 検出戦略

- テキスト内の数式表現の識別
- インライン方程式とブロック方程式の区別
- 一般的な数学記号と表記法の認識
- 下付き文字、上付き文字、分数の処理

### 処理パイプライン

1. 数式表現を含む領域の識別
2. 数学的内容の抽出
3. 表現構造とフォーマットの保持
4. レンダリング用のMathJax互換形式への変換

## 構造要素の検出

### 見出し検出

- 見出しレベルを判別するためのフォントサイズとスタイル分析
- 数値プレフィックス認識（例: "2.1", "2.2.1"）
- 見出し識別のためのコンテキスト分析
- 見出し間の階層関係の決定

### リスト検出

- 箇条書きと番号付きリストの認識
- リスト階層を判断するためのインデント分析
- リスト項目のグループ化と関係分析
- ネストされたリスト構造の保持

### 注釈とコールアウト検出

- ハイライトされたコンテンツの背景色または境界線分析
- 注釈やコールアウトを示すアイコンやシンボルの認識
- 特別なコンテンツの識別のためのスタイルの違いの識別
- キャプションと注釈の抽出

## 画像処理の実装アプローチ

### 前処理

```
1. グレースケール変換 → コントラスト調整 → ノイズ除去
2. 遠近歪み補正（必要な場合）
3. バイナリ化とエッジ検出
4. コンテンツ領域の特定とセグメンテーション
```

### OCR処理

```
1. 言語設定（日本語+英語）
2. ページ方向の自動検出
3. 領域ごとのOCR処理
4. 結果のポストプロセス（文字修正、信頼度フィルタリング）
```

### 構造検出

```
1. テキストブロックの位置とサイズに基づくグループ化
2. フォントサイズと特性に基づく要素分類
3. 相対位置関係による階層決定
4. 特殊マーカー（箇条書き記号、番号など）の検出
```

### 数式検出

```
1. 数式候補領域の特定（特殊記号密度、フォント変化）
2. 数式抽出処理
3. LaTeX形式への変換
4. MathJax互換形式の生成
```

## 課題と解決策

### 課題: 混在コンテンツ型

**解決策:**
- 異なるコンテンツタイプに特化した検出器を持つ多段階処理
- 詳細抽出前のコンテンツタイプ分類
- 抽出された要素の信頼度スコアリングと検証

### 課題: 複雑なレイアウト

**解決策:**
- 階層的なレイアウト分析アプローチ
- コンテンツフロー決定による領域ベースの処理
- 論理的なコンテンツ関係を確立するための後処理

### 課題: 画像品質のばらつき

**解決策:**
- 画像品質評価に基づく適応的な前処理
- 問題のある領域に対して異なるパラメータでの複数OCRパス
- 信頼度ベースの受け入れとフォールバック戦略

### 課題: 数学表記

**解決策:**
- 数学的コンテンツ用の特殊検出
- 数学的表現の構造を保持する抽出
- 適切なHTML/MathJaxレンダリングのためのフォーマット変換

## 画像処理の成功基準

| 評価指標 | 目標値 | 測定方法 |
|----------|---------|----------|
| テキスト抽出精度 | >95% | 抽出文字数÷総文字数 |
| 見出し検出精度 | >90% | 正しく識別された見出し÷総見出し数 |
| 数式抽出精度 | >90% | 正しく抽出された数式÷総数式数 |
| 構造識別精度 | >85% | 正しく識別された構造要素÷総構造要素数 |
| 処理時間効率 | 1ページあたり<30秒 | 平均処理時間測定 |

## 画像処理のベストプラクティス

### 入力画像の品質

- 高解像度画像の使用（少なくとも300 DPI）
- テキストと背景のコントラストが良好であることを確認
- 光沢、影、または傾いた視点を避ける
- コンテンツ領域のみを含むように画像をトリミング

### 日本語OCR最適化

- 日本語テキスト用に特化したOCRエンジンの使用
- 様々な日本語フォントスタイルでの訓練
- 縦書きと横書きの両方の処理
- 特殊文字と記号の適切な処理

### 構造検出の強化

- フォントサイズ、スタイル、位置に基づく階層分析
- コンテキスト情報を活用した見出しレベルの決定
- 一貫した視覚的パターンに基づくリスト項目のグループ化
- 囲み枠とバックグラウンドに基づく特殊コンテンツの検出

### 数式処理の最適化

- 専用の数式抽出ツールの統合
- 数式の有効性と構文チェック
- LaTeX形式への確実な変換
- MathJaxでの表示を確認するためのテストレンダリング

## LangGraphとの統合

画像処理コンポーネントはLangGraphワークフローの一部として次のように統合されます：

1. **状態定義**: ワークフローの状態オブジェクトには処理された画像データと抽出されたテキスト情報が含まれます

2. **ノード実装**: 画像処理はワークフロー内の特定ノードとして実装されます

3. **状態更新**: 各処理ステップは状態オブジェクトを更新して次のノードに渡します

4. **エラー処理**: 問題が発生した場合、ノードはエラー情報を状態に追加し、適切な回復パスに移行します

## 使用するライブラリとツール

システムは以下の主要なライブラリとツールを活用します：

1. **OpenCV**: 画像前処理と解析のための強力な画像処理ライブラリ
2. **Tesseract OCR**: 多言語対応のオープンソースOCRエンジン（日本語サポート含む）
3. **EasyOCR**: 日本語テキスト認識のための代替OCRライブラリ
4. **Mathpix API**: 数式認識と抽出のための専用サービス
5. **Pillow**: 基本的な画像操作のためのPythonイメージングライブラリ
6. **NumPy**: 効率的な数値計算と画像処理のための科学計算ライブラリ

## 将来の拡張予定

1. **深層学習ベースの構造認識**: 構造要素検出の精度向上のためのディープラーニングモデルの導入
2. **図表認識**: チャート、グラフ、ダイアグラムの自動検出と解析
3. **手書き日本語対応**: 手書きの日本語テキストの認識サポート
4. **リアルタイム処理**: より高速な処理のためのストリーミング処理パイプラインの実装
5. **マルチモーダル解析**: テキスト、画像、レイアウトを包括的に理解するための統合分析
